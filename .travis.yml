---
sudo: required
dist: trusty
language: node_js
node_js:
  - 14.0.0

branches:
  only:
    - 07-deployment

cache:
  directories:
    - node_modules

services:
  - docker

env:
  global:
    - NODE_ENV=local # should be TEST!

install:
  - npm install

before_script:
  - sudo service postgresql stop
  - docker ps
  - npm run infra
  - sleep 5
  - npm run db:migrate:deploy # should be without :deploy (but test env does not work yet)

script:
  - npm run test:coverage

after_success:
  - echo Upload code coverage # homework

notifications:
  - email: false

deploy:
  - provider: heroku
    skip_cleanup: true
    api_key:
      secure: 'r80qq8MhjamrmWrxh6N16Oi1Vb2v/RgbWb7bGYUWgPt3UrZ0shYQlcZcy4rbtSn4VSfFIf73Wd+Nu5ay0Q2oSPw8gB/ooU9BolfyXBJTVoU/xH7RUTFWz/APyJLYy7SexI3+HaNAvES51nYfhpAkEL1mDkHz3LhjWGSXgyBuGny4AkJmujwPv30j7TgrFEB+3My0hk3eySr7O76uk2A1PseE/WQiyOIgKKoYiaDrps2CzuQ7Qb21D3nx0gLOLMXG0xA7bVGB/gAXjKRBNH/uNgcmc+kmYFvJJdSuw4kbY8Q/3J3EhdzvMnyUHuXa3t7iWlekkt/NdwAoM3VmaGOqsJtILquvTqUmuiubsFqsBLnUbMO6CH0RNtIj8jb5+bQzHL8XuBZ2dWx57Z1n/mT+iNRM+j8PnRBUtDmP2syBMlMgBp97klxuHXCy+dHg4484Cn3v6T5d7Q7blcUAJSe8DukVkO1F5/BED22J8m2QDOmrxLEndmOzjK9gGlirIxoI8adTsTcxXCvjvyPZMP6yt/rHBSZXZk5OMI/TmKhuEugrPx4L5JNCMLIr06ZQHrLaoWKLJA1xSOAxlfvtQ2tdlNYuUW1lrPf9XY5IyPXM0TBJXkuodVZdkbIqh+qsKgbZkFgTpJ4z30c3Wdft/Wy1/Y95huyRJoFex/WXZFYe3as='
    app: dogbook2022
    strategy: git
    on:
      branch:
        - 07-deployment
      repo: haraslub/dogbook
